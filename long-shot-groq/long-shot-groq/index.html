<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Long Shot - AI-Powered Stock Analysis</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <!-- Sleek Tech Font: Outfit (modern, geometric, tech-focused) -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        body {
            font-family: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        }
        
        /* Cool wiggle animation for money being chewed */
        @keyframes wiggle {
            0%, 100% { transform: rotate(-3deg) translateX(0); }
            25% { transform: rotate(3deg) translateX(2px); }
            50% { transform: rotate(-3deg) translateX(-2px); }
            75% { transform: rotate(3deg) translateX(2px); }
        }
        
        .animate-wiggle {
            animation: wiggle 0.5s ease-in-out infinite;
        }
        
        /* Professional animations */
        @keyframes pulse-slow {
            0%, 100% { 
                transform: scale(1);
                box-shadow: 0 20px 50px rgba(16, 185, 129, 0.3);
            }
            50% { 
                transform: scale(1.05);
                box-shadow: 0 25px 60px rgba(16, 185, 129, 0.5);
            }
        }
        
        .animate-pulse-slow {
            animation: pulse-slow 4s ease-in-out infinite;
        }
        
        @keyframes bounce-slow {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-8px); }
        }
        
        .animate-bounce-slow {
            animation: bounce-slow 2s ease-in-out infinite;
        }
        
        /* Long Shot themed animations */
        @keyframes milk-drip {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(10px); }
        }
        
        .milk-drip {
            animation: milk-drip 2s ease-in-out infinite;
        }
        
        /* Bouncing cow animation */
        @keyframes gentle-bounce {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
        
        .gentle-bounce {
            animation: gentle-bounce 3s ease-in-out infinite;
        }
        
        /* Gradient text shine */
        @keyframes shine {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-900 via-blue-900 to-slate-900 min-h-screen p-8">
    <div class="max-w-4xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-7xl font-black text-white mb-3 tracking-tight" style="letter-spacing: -0.02em;">
                <span class="bg-gradient-to-r from-amber-400 via-yellow-300 to-orange-400 bg-clip-text text-transparent" style="font-weight: 900;">
                    LONG SHOT
                </span>
                <sup class="text-xl text-amber-300" style="font-weight: 500;">‚Ñ¢</sup>
            </h1>
            <p class="text-amber-200 text-xl font-bold tracking-wide uppercase" style="letter-spacing: 0.15em;">AI-Powered Investment Intelligence</p>
            <div class="flex items-center justify-center gap-3 mt-3">
                <div class="h-px w-12 bg-gradient-to-r from-transparent to-amber-400"></div>
                <p class="text-amber-300 text-sm font-semibold uppercase" style="letter-spacing: 0.1em;">Taking Calculated Risks, Hitting Big Wins</p>
                <div class="h-px w-12 bg-gradient-to-l from-transparent to-amber-400"></div>
            </div>
            <div class="mt-4 px-4 py-2 bg-green-500/20 rounded-lg border border-green-500/50">
                <p class="text-green-300 text-xs font-semibold">‚ö° Powered by Groq AI - Lightning Fast & FREE!</p>
            </div>
        </div>

        <!-- Mode Selection Tabs -->
        <div class="flex gap-4 mb-6">
            <button 
                id="suggestionsTab" 
                onclick="switchMode('suggestions')"
                class="flex-1 bg-blue-600 text-white font-bold py-3 px-6 rounded-lg transition-all"
            >
                üìä Stock Suggestions
            </button>
            <button 
                id="ratingTab" 
                onclick="switchMode('rating')"
                class="flex-1 bg-white/20 text-white font-bold py-3 px-6 rounded-lg hover:bg-white/30 transition-all"
            >
                ‚≠ê Ticker Rating
            </button>
        </div>

        <!-- Suggestions Mode Input Card -->
        <div id="suggestionsCard" class="input-card">
        <div class="bg-white/10 backdrop-blur-lg rounded-xl p-6 mb-6 border border-white/20">
            <div class="space-y-4">
                <div>
                    <label class="block text-white font-medium mb-2">Your Email</label>
                    <input 
                        type="email" 
                        id="emailInput" 
                        placeholder="your.email@example.com"
                        class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    />
                </div>

                <div>
                    <label class="block text-white font-medium mb-2">Focus Areas (optional)</label>
                    <input 
                        type="text" 
                        id="sectorsInput" 
                        placeholder="e.g., Technology, Healthcare, Energy"
                        class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400"
                    />
                </div>

                <div>
                    <label class="block text-white font-medium mb-2">Investment Style</label>
                    <select 
                        id="styleSelect"
                        class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white focus:outline-none focus:ring-2 focus:ring-blue-400"
                    >
                        <option value="balanced">Balanced</option>
                        <option value="growth">Growth-focused</option>
                        <option value="value">Value-focused</option>
                        <option value="dividend">Dividend-focused</option>
                    </select>
                </div>

                <div class="bg-white/5 rounded-lg p-4 border border-white/20">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input 
                            type="checkbox" 
                            id="technicalAnalysis"
                            class="w-5 h-5 rounded bg-white/20 border-white/30 text-blue-500 focus:ring-2 focus:ring-blue-400"
                        />
                        <div>
                            <div class="text-white font-medium">üìä Include Technical Analysis</div>
                            <div class="text-blue-200 text-sm">Add analysis of moving averages, RSI, momentum indicators, and chart patterns</div>
                        </div>
                    </label>
                </div>

                <div class="bg-white/5 rounded-lg p-4 border border-white/20">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input 
                            type="checkbox" 
                            id="optionsStrategy"
                            class="w-5 h-5 rounded bg-white/20 border-white/30 text-blue-500 focus:ring-2 focus:ring-blue-400"
                        />
                        <div>
                            <div class="text-white font-medium">üéØ Include Options Strategy</div>
                            <div class="text-blue-200 text-sm">Add specific options recommendations with strike prices, expiry, Greeks, and strategy rationale</div>
                        </div>
                    </label>
                </div>

                <div class="bg-white/5 rounded-lg p-4 border border-white/20">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input 
                            type="checkbox" 
                            id="conservativeSpreads"
                            class="w-5 h-5 rounded bg-white/20 border-white/30 text-blue-500 focus:ring-2 focus:ring-blue-400"
                        />
                        <div>
                            <div class="text-white font-medium">üõ°Ô∏è Focus on Conservative OTM Spreads</div>
                            <div class="text-blue-200 text-sm">Prioritize far out-of-the-money credit spreads with higher probability, lower profit, and significantly reduced risk</div>
                        </div>
                    </label>
                </div>

                <button 
                    onclick="generateReport()" 
                    id="generateBtn"
                    class="w-full bg-gradient-to-r from-blue-500 to-purple-600 text-white font-bold py-3 px-6 rounded-lg hover:from-blue-600 hover:to-purple-700 transition-all transform hover:scale-105 shadow-lg"
                >
                    üêÑ Milk the Market for Stock Picks! üí∞
                </button>
            </div>
        </div>
        </div>

        <!-- Ticker Rating Mode Input Card -->
        <div id="ratingCard" class="hidden">
        <div class="bg-white/10 backdrop-blur-lg rounded-xl p-6 mb-6 border border-white/20">
            <div class="space-y-4">
                <div>
                    <label class="block text-white font-medium mb-2">Stock Ticker Symbol</label>
                    <input 
                        type="text" 
                        id="tickerInput" 
                        placeholder="e.g., AAPL, TSLA, MSFT"
                        class="w-full px-4 py-3 rounded-lg bg-white/20 border border-white/30 text-white placeholder-white/50 focus:outline-none focus:ring-2 focus:ring-blue-400 uppercase"
                    />
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div class="bg-white/5 rounded-lg p-3 border border-white/20 text-center">
                        <label class="flex items-center justify-center space-x-2 cursor-pointer">
                            <input 
                                type="checkbox" 
                                id="rateTechnical"
                                checked
                                class="w-4 h-4 rounded bg-white/20 border-white/30 text-blue-500"
                            />
                            <span class="text-white text-sm">üìä Technical</span>
                        </label>
                    </div>
                    <div class="bg-white/5 rounded-lg p-3 border border-white/20 text-center">
                        <label class="flex items-center justify-center space-x-2 cursor-pointer">
                            <input 
                                type="checkbox" 
                                id="rateFundamental"
                                checked
                                class="w-4 h-4 rounded bg-white/20 border-white/30 text-blue-500"
                            />
                            <span class="text-white text-sm">üíº Fundamental</span>
                        </label>
                    </div>
                    <div class="bg-white/5 rounded-lg p-3 border border-white/20 text-center">
                        <label class="flex items-center justify-center space-x-2 cursor-pointer">
                            <input 
                                type="checkbox" 
                                id="rateOptions"
                                checked
                                class="w-4 h-4 rounded bg-white/20 border-white/30 text-blue-500"
                            />
                            <span class="text-white text-sm">üéØ Options</span>
                        </label>
                    </div>
                </div>

                <div class="bg-white/5 rounded-lg p-4 border border-white/20">
                    <label class="flex items-center space-x-3 cursor-pointer">
                        <input 
                            type="checkbox" 
                            id="rateConservativeSpreads"
                            class="w-5 h-5 rounded bg-white/20 border-white/30 text-blue-500"
                        />
                        <div>
                            <div class="text-white font-medium">üõ°Ô∏è Conservative OTM Spreads Focus</div>
                            <div class="text-blue-200 text-sm">Recommend far OTM credit spreads with high probability and lower risk</div>
                        </div>
                    </label>
                </div>

                <button 
                    onclick="rateTicker()" 
                    id="rateBtn"
                    class="w-full bg-gradient-to-r from-purple-500 to-pink-600 text-white font-bold py-3 px-6 rounded-lg hover:from-purple-600 hover:to-pink-700 transition-all transform hover:scale-105 shadow-lg"
                >
                    üêÑ Moo-ve Over, Let's Rate This! ‚≠ê
                </button>
            </div>
        </div>
        </div>

        <!-- Status Display -->
        <div id="statusDisplay" class="hidden bg-white/10 backdrop-blur-lg rounded-xl p-6 mb-6 border border-white/20">
            <div class="flex items-center space-x-3 mb-3">
                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-white"></div>
                <span class="text-white" id="statusText">Searching for latest stock news...</span>
            </div>
            <div class="w-full bg-white/20 rounded-full h-2">
                <div id="progressBar" class="bg-blue-500 h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <!-- Results Display -->
        <div id="resultsDisplay" class="hidden bg-white/10 backdrop-blur-lg rounded-xl p-6 border border-white/20">
            <h2 class="text-2xl font-bold text-white mb-4">üìß Email Preview & Edit</h2>
            
            <!-- Edit Mode Toggle -->
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center space-x-2">
                    <span class="text-white font-medium">Preview Mode:</span>
                    <button 
                        id="viewModeBtn"
                        onclick="setEditMode(false)"
                        class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium transition-all"
                    >
                        üëÅÔ∏è View
                    </button>
                    <button 
                        id="editModeBtn"
                        onclick="setEditMode(true)"
                        class="px-4 py-2 bg-white/20 text-white rounded-lg font-medium hover:bg-white/30 transition-all"
                    >
                        ‚úèÔ∏è Edit
                    </button>
                </div>
                <div class="text-blue-200 text-sm">
                    üí° Review and edit before sending
                </div>
            </div>

            <div class="bg-white rounded-lg p-6 shadow-xl">
                <!-- Subject Line (Editable) -->
                <div class="border-b pb-4 mb-4">
                    <div class="text-sm text-gray-600 mb-1">Subject:</div>
                    <div id="subjectView" class="font-bold text-lg"></div>
                    <input 
                        type="text" 
                        id="subjectEdit" 
                        class="hidden w-full px-3 py-2 border border-gray-300 rounded-lg font-bold text-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                    />
                </div>

                <!-- Email Body (Editable) -->
                <div id="emailBodyView" class="prose max-w-none"></div>
                <textarea 
                    id="emailBodyEdit" 
                    class="hidden w-full px-4 py-3 border border-gray-300 rounded-lg min-h-[500px] focus:outline-none focus:ring-2 focus:ring-blue-400 font-mono text-sm"
                ></textarea>
            </div>

            <!-- Action Buttons -->
            <div class="mt-6 space-y-3">
                <!-- Save Changes Button (only visible in edit mode) -->
                <button 
                    id="saveChangesBtn"
                    onclick="saveChanges()" 
                    class="hidden w-full bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition-all shadow-lg"
                >
                    ‚úÖ Save Changes
                </button>

                <!-- Main Action Buttons -->
                <div class="grid grid-cols-3 gap-3">
                    <button 
                        onclick="copyToClipboard()" 
                        class="bg-blue-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-600 transition-all"
                    >
                        üìã Copy Moo-sings
                    </button>
                    <button 
                        onclick="openInEmail()" 
                        class="bg-purple-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-purple-600 transition-all"
                    >
                        üìß Email This Hay!
                    </button>
                    <button 
                        onclick="downloadAsFile()" 
                        class="bg-indigo-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-indigo-600 transition-all"
                    >
                        üíæ Save to Barn
                    </button>
                </div>

                <!-- Regenerate Button -->
                <button 
                    onclick="regenerateReport()" 
                    class="w-full bg-orange-500 text-white font-bold py-3 px-6 rounded-lg hover:bg-orange-600 transition-all"
                >
                    üîÑ Get Fresh Milk (New Analysis)
                </button>
            </div>
        </div>
        
        <!-- Professional Long Shot Footer -->
        <div class="mt-8 text-center pb-8">
            <div class="bg-gradient-to-r from-amber-900/40 via-green-900/40 to-teal-900/40 backdrop-blur-lg rounded-xl p-6 border border-emerald-500/30 shadow-xl">
                <div class="flex items-center justify-center gap-3 mb-3">
                    <div class="bg-amber-500/20 rounded-full p-3">
                        <span class="text-3xl">üêÑ</span>
                    </div>
                    <div>
                        <span class="text-white font-black text-2xl tracking-wide">Long Shot</span>
                        <sup class="text-xs text-amber-300">‚Ñ¢</sup>
                    </div>
                </div>
                <p class="text-amber-200 text-sm font-semibold mb-3">
                    AI-Powered Investment Intelligence
                </p>
                <div class="flex items-center justify-center gap-2 mb-3">
                    <div class="h-px w-8 bg-gradient-to-r from-transparent to-amber-400"></div>
                    <p class="text-amber-300 text-xs font-medium">
                        Intelligent Analysis ‚Ä¢ Strategic Insights ‚Ä¢ Data-Driven Decisions
                    </p>
                    <div class="h-px w-8 bg-gradient-to-l from-transparent to-amber-400"></div>
                </div>
                <div class="mt-4 pt-3 border-t border-emerald-500/20">
                    <p class="text-amber-400/60 text-xs leading-relaxed">
                        This platform provides AI-powered market analysis for informational purposes only.<br>
                        Not financial advice. Past performance does not guarantee future results.
                    </p>
                    <p class="text-amber-500/40 text-xs mt-2">
                        ¬© 2026 Long Shot‚Ñ¢ ‚Ä¢ All Rights Reserved
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentEmailContent = { subject: '', body: '' };
        let currentMode = 'suggestions';
        let isEditMode = false;

        function setEditMode(editMode) {
            isEditMode = editMode;
            
            // Update button states
            if (editMode) {
                document.getElementById('viewModeBtn').classList.remove('bg-blue-600');
                document.getElementById('viewModeBtn').classList.add('bg-white/20', 'hover:bg-white/30');
                document.getElementById('editModeBtn').classList.remove('bg-white/20', 'hover:bg-white/30');
                document.getElementById('editModeBtn').classList.add('bg-blue-600');
                
                // Show edit fields, hide view
                document.getElementById('subjectView').classList.add('hidden');
                document.getElementById('subjectEdit').classList.remove('hidden');
                document.getElementById('emailBodyView').classList.add('hidden');
                document.getElementById('emailBodyEdit').classList.remove('hidden');
                document.getElementById('saveChangesBtn').classList.remove('hidden');
                
                // Populate edit fields with current content
                document.getElementById('subjectEdit').value = currentEmailContent.subject;
                document.getElementById('emailBodyEdit').value = stripHTML(currentEmailContent.body);
            } else {
                document.getElementById('viewModeBtn').classList.remove('bg-white/20', 'hover:bg-white/30');
                document.getElementById('viewModeBtn').classList.add('bg-blue-600');
                document.getElementById('editModeBtn').classList.remove('bg-blue-600');
                document.getElementById('editModeBtn').classList.add('bg-white/20', 'hover:bg-white/30');
                
                // Show view fields, hide edit
                document.getElementById('subjectView').classList.remove('hidden');
                document.getElementById('subjectEdit').classList.add('hidden');
                document.getElementById('emailBodyView').classList.remove('hidden');
                document.getElementById('emailBodyEdit').classList.add('hidden');
                document.getElementById('saveChangesBtn').classList.add('hidden');
            }
        }

        function saveChanges() {
            // Get edited content
            const newSubject = document.getElementById('subjectEdit').value;
            const newBody = document.getElementById('emailBodyEdit').value;
            
            // Convert plain text back to HTML (preserve line breaks)
            const htmlBody = newBody
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\n\n/g, '<br><br>')
                .replace(/\n/g, '<br>');
            
            // Update current content
            currentEmailContent.subject = newSubject;
            currentEmailContent.body = `<div style="font-family: Arial, sans-serif; line-height: 1.8; color: #333;">${htmlBody}</div>`;
            
            // Update view
            document.getElementById('subjectView').textContent = newSubject;
            document.getElementById('emailBodyView').innerHTML = currentEmailContent.body;
            
            // Switch back to view mode
            setEditMode(false);
            
            // Show success message
            showNotification('‚úÖ Changes saved successfully!');
        }

        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-3 rounded-lg shadow-lg z-50 animate-fade-in';
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transition = 'opacity 0.3s';
                setTimeout(() => notification.remove(), 300);
            }, 2000);
        }

        function regenerateReport() {
            if (confirm('This will generate a new analysis with fresh data. Continue?')) {
                // Clear current results
                document.getElementById('resultsDisplay').classList.add('hidden');
                
                // Trigger regeneration based on current mode
                if (currentMode === 'suggestions') {
                    generateReport();
                } else {
                    rateTicker();
                }
            }
        }

        function downloadAsFile() {
            const content = `Subject: ${currentEmailContent.subject}\n\n${stripHTML(currentEmailContent.body)}`;
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `stock-analysis-${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showNotification('üì• Downloaded successfully!');
        }

        function switchMode(mode) {
            currentMode = mode;
            
            if (mode === 'suggestions') {
                document.getElementById('suggestionsCard').classList.remove('hidden');
                document.getElementById('ratingCard').classList.add('hidden');
                document.getElementById('suggestionsTab').classList.remove('bg-white/20');
                document.getElementById('suggestionsTab').classList.add('bg-blue-600');
                document.getElementById('ratingTab').classList.remove('bg-blue-600');
                document.getElementById('ratingTab').classList.add('bg-white/20');
            } else {
                document.getElementById('suggestionsCard').classList.add('hidden');
                document.getElementById('ratingCard').classList.remove('hidden');
                document.getElementById('suggestionsTab').classList.remove('bg-blue-600');
                document.getElementById('suggestionsTab').classList.add('bg-white/20');
                document.getElementById('ratingTab').classList.remove('bg-white/20');
                document.getElementById('ratingTab').classList.add('bg-blue-600');
            }
            
            // Hide results when switching modes
            document.getElementById('resultsDisplay').classList.add('hidden');
            document.getElementById('statusDisplay').classList.add('hidden');
        }

        async function rateTicker() {
            const ticker = document.getElementById('tickerInput').value.trim().toUpperCase();
            const includeTechnical = document.getElementById('rateTechnical').checked;
            const includeFundamental = document.getElementById('rateFundamental').checked;
            const includeOptions = document.getElementById('rateOptions').checked;
            const conservativeSpreads = document.getElementById('rateConservativeSpreads').checked;

            if (!ticker) {
                alert('Please enter a stock ticker symbol');
                return;
            }

            // Show status
            document.getElementById('statusDisplay').classList.remove('hidden');
            document.getElementById('resultsDisplay').classList.add('hidden');
            document.getElementById('rateBtn').disabled = true;
            document.getElementById('rateBtn').textContent = 'Analyzing...';

            try {
                const analysisTypes = [];
                if (includeFundamental) analysisTypes.push('Fundamental');
                if (includeTechnical) analysisTypes.push('Technical');
                if (includeOptions) analysisTypes.push('Options');

                // Step 1: Search for comprehensive data on the ticker
                updateStatus(`üîç Gathering ${analysisTypes.join(', ')} data for ${ticker}...`);
                
                const searchQuery = `${ticker} stock ${analysisTypes.map(t => t.toLowerCase()).join(' ')} analysis news price earnings technical indicators options`;

                const searchResponse = await fetch("/.netlify/functions/anthropic-proxy", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 6000,
                        tools: [{
                            type: "web_search_20250305",
                            name: "web_search"
                        }],
                        messages: [{
                            role: "user",
                            content: `Search for comprehensive information about ${ticker} stock including: current price, recent news, ${includeFundamental ? 'fundamental analysis (earnings, P/E ratio, revenue, margins, analyst ratings),' : ''} ${includeTechnical ? 'technical analysis (moving averages, RSI, MACD, support/resistance, trend),' : ''} ${includeOptions ? 'options data (IV percentile, open interest, options volume, Greeks),' : ''} and overall market sentiment.`
                        }]
                    })
                });

                const searchData = await searchResponse.json();

                // Step 2: Generate comprehensive rating
                updateStatus('ü§ñ AI analyzing data and generating rating...');

                const ratingPrompt = `Based on the comprehensive data you found for ${ticker}, create a detailed stock rating report.

CRITICAL TONE INSTRUCTIONS: Write this as if YOU are a professional trader analyzing ${ticker} for YOUR OWN portfolio. Be:
- BRUTALLY HONEST: If it's overvalued garbage, say so. If it's a screaming buy, say that too.
- STRAIGHTFORWARD: No corporate BS. Cut to the chase.
- PERSONAL: Use "I" - "I'd buy this" or "I'm staying away because..."
- OPINIONATED: Strong views. "This is a BUY" or "This is a PASS" - no fence-sitting.
- CONVERSATIONAL: Write like you're explaining to a friend over drinks, not pitching to a committee.
- REAL: Admit what you don't know. "The fundamentals look great but I'm worried about..."
- CUTTHROAT: Call out red flags immediately. Your reputation is on the line.

**FORMAT YOUR RESPONSE AS FOLLOWS:**

**SUBJECT LINE:**
${ticker} Rating: [Your actual rating] - [Punchy one-liner on your take]

---

**MY RATING:**

**Overall Score: [X]/100** (Be honest - scores in the 40s are okay if the stock sucks)
${includeFundamental ? '- Fundamentals: [X]/100 - [One word: Strong/Decent/Weak/Terrible]' : ''}
${includeTechnical ? '- Technicals: [X]/100 - [One word: Bullish/Neutral/Bearish/Ugly]' : ''}
${includeOptions ? '- Options Setup: [X]/100 - [One word: Attractive/Okay/Poor/Avoid]' : ''}

**My Call: [STRONG BUY / BUY / HOLD / SELL / STRONG SELL / HELL NO]**

**Quick Take**: [2-3 sentences - your gut reaction to ${ticker} right now - be blunt]

Make the analysis thorough, data-driven, and actionable. Use specific numbers from your search results.`;

                const analysisResponse = await fetch("/.netlify/functions/anthropic-proxy", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 6000,
                        messages: [
                            {
                                role: "user",
                                content: `Search for comprehensive information about ${ticker} stock including: current price, recent news, ${includeFundamental ? 'fundamental analysis (earnings, P/E ratio, revenue, margins, analyst ratings),' : ''} ${includeTechnical ? 'technical analysis (moving averages, RSI, MACD, support/resistance, trend),' : ''} ${includeOptions ? 'options data (IV percentile, open interest, options volume, Greeks),' : ''} and overall market sentiment.`
                            },
                            {
                                role: "assistant",
                                content: searchData.content
                            },
                            {
                                role: "user",
                                content: ratingPrompt
                            }
                        ]
                    })
                });

                const analysisData = await analysisResponse.json();

                // Extract the response text
                const responseText = analysisData.content
                    .filter(item => item.type === 'text')
                    .map(item => item.text)
                    .join('\n');

                // Parse subject and body from formatted response
                const lines = responseText.split('\n');
                let subject = `Stock Rating: ${ticker}`;
                let bodyStartIndex = 0;
                
                // Look for subject line
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('SUBJECT') || lines[i].includes('Subject:')) {
                        for (let j = i + 1; j < lines.length; j++) {
                            if (lines[j].trim() && !lines[j].includes('---')) {
                                subject = lines[j].trim();
                                bodyStartIndex = j + 1;
                                break;
                            }
                        }
                        break;
                    }
                }
                
                // Get body
                let body = lines.slice(bodyStartIndex)
                    .filter(line => !line.includes('---') && !line.includes('RATING SUMMARY'))
                    .join('\n')
                    .trim();
                
                // Convert formatting to HTML
                body = body
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n- /g, '\n‚Ä¢ ')
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n/g, '<br>');

                const emailData = {
                    subject: subject,
                    body: `<div style="font-family: Arial, sans-serif; line-height: 1.8; color: #333;">${body}</div>`
                };

                // Display results in preview
                currentEmailContent = emailData;
                document.getElementById('subjectView').textContent = emailData.subject;
                document.getElementById('subjectEdit').value = emailData.subject;
                document.getElementById('emailBodyView').innerHTML = addCashCowBranding(emailData.body);
                document.getElementById('emailBodyEdit').value = stripHTML(emailData.body);
                
                // Make sure we're in view mode
                setEditMode(false);
                
                document.getElementById('resultsDisplay').classList.remove('hidden');
                document.getElementById('statusDisplay').classList.add('hidden');

            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while rating the stock. Please try again.');
                document.getElementById('statusDisplay').classList.add('hidden');
            } finally {
                document.getElementById('rateBtn').disabled = false;
                document.getElementById('rateBtn').textContent = '‚≠ê Rate This Stock';
            }
        }

        async function generateReport() {
            const email = document.getElementById('emailInput').value.trim();
            const sectors = document.getElementById('sectorsInput').value.trim();
            const style = document.getElementById('styleSelect').value;
            const includeTechnicals = document.getElementById('technicalAnalysis').checked;
            const includeOptions = document.getElementById('optionsStrategy').checked;
            const conservativeSpreads = document.getElementById('conservativeSpreads').checked;

            if (!email) {
                alert('Please enter your email address');
                return;
            }

            // Show status
            document.getElementById('statusDisplay').classList.remove('hidden');
            document.getElementById('resultsDisplay').classList.add('hidden');
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateBtn').textContent = 'Analyzing...';

            try {
                // Run all searches in parallel for much faster execution
                updateStatus('üîç Searching for market data in parallel...', 10);
                
                const searchPromises = [];
                
                // Always search for stock news
                searchPromises.push(
                    fetch("/.netlify/functions/anthropic-proxy", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            model: "claude-sonnet-4-20250514",
                            max_tokens: 3000,
                            tools: [{ type: "web_search_20250305", name: "web_search" }],
                            messages: [{
                                role: "user",
                                content: `Search for the latest stock market news and significant market movements. Focus on: ${sectors || 'all major sectors'}. Find recent news about stocks with positive momentum, analyst upgrades, earnings beats, or other bullish catalysts. ALSO search for machine learning price predictions (XGBoost, LightGBM, GBDT forecasts) for trending stocks.`
                            }]
                        })
                    }).then(r => r.json())
                );
                
                // 2. If technical analysis requested, add to parallel searches
                if (includeTechnicals) {
                    searchPromises.push(
                        fetch("/.netlify/functions/anthropic-proxy", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                model: "claude-sonnet-4-20250514",
                                max_tokens: 2000,
                                tools: [{ type: "web_search_20250305", name: "web_search" }],
                                messages: [{
                                    role: "user",
                                    content: `Search for technical analysis and chart patterns for popular stocks. Look for information about: moving averages (50-day, 200-day), RSI levels, MACD signals, volume trends, support/resistance levels, and momentum indicators. Focus on stocks showing bullish technical setups${sectors ? ' in sectors: ' + sectors : ''}.`
                                }]
                            })
                        }).then(r => r.json())
                    );
                } else {
                    searchPromises.push(null);
                }
                
                // 3. If options requested, add to parallel searches
                if (includeOptions) {
                    searchPromises.push(
                        fetch("/.netlify/functions/anthropic-proxy", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                model: "claude-sonnet-4-20250514",
                                max_tokens: 3000,
                                tools: [{ type: "web_search_20250305", name: "web_search" }],
                                messages: [{
                                    role: "user",
                                    content: `Search for COMPREHENSIVE options trading data covering ALL technical and fundamental parameters for stocks and ETFs${sectors ? ' in sectors: ' + sectors : ''}. Focus on stocks with liquid options markets.`
                                }]
                            })
                        }).then(r => r.json())
                    );
                } else {
                    searchPromises.push(null);
                }
                
                // Execute all searches in parallel
                const [searchData, technicalSearchData, optionsSearchData] = await Promise.all(searchPromises);
                
                updateStatus('‚úÖ Data gathered! Now analyzing...', 60);
                console.log('All searches completed in parallel');

                // Step 4: Analyze and generate suggestions
                updateStatus('ü§ñ AI analyzing market data and generating suggestions...', 70);
                const messages = [
                    {
                        role: "user",
                        content: `Search for the latest stock market news and significant market movements. Focus on: ${sectors || 'all major sectors'}. Find recent news about stocks with positive momentum, analyst upgrades, earnings beats, or other bullish catalogs.`
                    },
                    {
                        role: "assistant",
                        content: searchData.content
                    }
                ];

                // Add technical analysis search if it was performed
                if (includeTechnicals && technicalSearchData) {
                    messages.push({
                        role: "user",
                        content: `Search for technical analysis and chart patterns for popular stocks. Look for information about: moving averages (50-day, 200-day), RSI levels, MACD signals, volume trends, support/resistance levels, and momentum indicators. Focus on stocks showing bullish technical setups${sectors ? ' in sectors: ' + sectors : ''}.`
                    });
                    messages.push({
                        role: "assistant",
                        content: technicalSearchData.content
                    });
                }

                // Add options analysis search if it was performed
                if (includeOptions && optionsSearchData) {
                    messages.push({
                        role: "user",
                        content: `Search for comprehensive options data and volatility metrics for popular stocks and ETFs${sectors ? ' in sectors: ' + sectors : ''}.`
                    });
                    messages.push({
                        role: "assistant",
                        content: optionsSearchData.content
                    });
                }

                // Create the final analysis prompt
                let finalPrompt = `Based on the latest stock market news you found, create a professional email report with stock suggestions for an investor with a ${style} investment style.`;

                messages.push({
                    role: "user",
                    content: finalPrompt
                });

                const analysisResponse = await fetch("/.netlify/functions/anthropic-proxy", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 4000,
                        messages: messages
                    })
                });

                const analysisData = await analysisResponse.json();
                console.log('Analysis results:', analysisData);

                updateStatus('üìù Formatting results...', 90);

                // Extract the response text
                const responseText = analysisData.content
                    .filter(item => item.type === 'text')
                    .map(item => item.text)
                    .join('\n');

                // Parse subject and body from formatted response
                const lines = responseText.split('\n');
                let subject = 'Stock Market Suggestions';
                let bodyStartIndex = 0;
                
                // Look for subject line
                for (let i = 0; i < lines.length; i++) {
                    if (lines[i].includes('SUBJECT') || lines[i].includes('Subject:')) {
                        for (let j = i + 1; j < lines.length; j++) {
                            if (lines[j].trim() && !lines[j].includes('---')) {
                                subject = lines[j].trim();
                                bodyStartIndex = j + 1;
                                break;
                            }
                        }
                        break;
                    }
                }
                
                // Get body (everything after subject, skipping separator lines)
                let body = lines.slice(bodyStartIndex)
                    .filter(line => !line.includes('---') && !line.includes('EMAIL BODY'))
                    .join('\n')
                    .trim();
                
                // Convert markdown-style formatting to HTML for better display
                body = body
                    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n- /g, '\n‚Ä¢ ')
                    .replace(/\n\n/g, '<br><br>')
                    .replace(/\n/g, '<br>');

                const emailData = {
                    subject: subject,
                    body: `<div style="font-family: Arial, sans-serif; line-height: 1.8; color: #333;">${body}</div>`
                };

                // Display results in preview
                currentEmailContent = emailData;
                document.getElementById('subjectView').textContent = emailData.subject;
                document.getElementById('subjectEdit').value = emailData.subject;
                document.getElementById('emailBodyView').innerHTML = addCashCowBranding(emailData.body);
                document.getElementById('emailBodyEdit').value = stripHTML(emailData.body);
                
                // Make sure we're in view mode
                setEditMode(false);
                
                document.getElementById('resultsDisplay').classList.remove('hidden');
                document.getElementById('statusDisplay').classList.add('hidden');

            } catch (error) {
                console.error('Error:', error);
                alert('An error occurred while generating the report. Please try again.');
                document.getElementById('statusDisplay').classList.add('hidden');
            } finally {
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('generateBtn').textContent = 'Generate Stock Suggestions';
            }
        }

        let currentProgress = 0;
        const funnyMessages = [
            "üêÑ Milking the data streams...",
            "üí∞ Counting money (in cow language)...",
            "üìä Teaching AI to moo-ve markets...",
            "ü•õ Squeezing fresh insights...",
            "üöÄ Launching cow to the moon...",
            "ü§ñ AI is grazing through the data...",
            "üí∏ Making it rain (from udders)...",
            "üéØ Aiming for the bullseye (not the bullüí©)...",
            "üß† Training ML models to think like Warren Buffett's cow...",
            "‚ö° Turbo-charging your portfolio (with hay fuel)..."
        ];
        
        function updateStatus(message, progress = null) {
            // Add random funny message occasionally
            if (Math.random() > 0.7 && !message.includes('üêÑ')) {
                const randomFunny = funnyMessages[Math.floor(Math.random() * funnyMessages.length)];
                message = randomFunny;
            }
            
            document.getElementById('statusText').textContent = message;
            if (progress !== null) {
                const bar = document.getElementById('progressBar');
                if (bar) bar.style.width = progress + '%';
            }
        }

        function copyToClipboard() {
            const fullEmail = `Subject: ${currentEmailContent.subject}\n\n${stripHTML(currentEmailContent.body)}`;
            navigator.clipboard.writeText(fullEmail).then(() => {
                alert('Email copied to clipboard!');
            });
        }

        function openInEmail() {
            const email = document.getElementById('emailInput').value.trim();
            const subject = encodeURIComponent(currentEmailContent.subject);
            const body = encodeURIComponent(stripHTML(currentEmailContent.body));
            window.open(`mailto:${email}?subject=${subject}&body=${body}`);
        }

        function stripHTML(html) {
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }
        
        function addCashCowBranding(emailBody) {
            // Add Long Shot branding without the large SVG cow logo
            return `
            <div style="font-family: 'Outfit', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; max-width: 800px; margin: 0 auto;">
                <!-- Professional Header - Text Only (No SVG Logo) -->
                <div style="text-align: center; padding: 35px 30px; background: linear-gradient(135deg, #059669 0%, #10b981 50%, #14b8a6 100%); border-radius: 16px; margin-bottom: 30px; box-shadow: 0 10px 30px rgba(16, 185, 129, 0.3);">
                    <h1 style="color: #ffffff; font-size: 48px; font-weight: 900; margin: 0; text-shadow: 2px 2px 8px rgba(0,0,0,0.2); letter-spacing: -0.02em; text-transform: uppercase;">
                        LONG SHOT<sup style="font-size: 18px; font-weight: 500;">‚Ñ¢</sup>
                    </h1>
                    <p style="color: #d1fae5; font-size: 14px; margin: 12px 0 0 0; font-weight: 700; letter-spacing: 0.15em; text-transform: uppercase;">
                        AI-Powered Investment Intelligence
                    </p>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.3);">
                        <p style="color: #a7f3d0; font-size: 11px; margin: 0; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase;">
                            Taking Calculated Risks ‚Ä¢ Data-Driven Decisions
                        </p>
                    </div>
                </div>
                
                <!-- Email Content -->
                <div style="background: white; padding: 35px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05);">
                    ${emailBody}
                </div>
                
                <!-- Professional Footer -->
                <div style="text-align: center; padding: 30px; background: linear-gradient(135deg, #1e293b 0%, #334155 100%); border-radius: 16px; margin-top: 30px; border-top: 4px solid #10b981;">
                    <div style="margin-bottom: 15px;">
                        <span style="font-size: 48px;">üêÑ</span>
                    </div>
                    <p style="color: #94a3b8; font-size: 16px; margin: 10px 0; font-weight: 800; letter-spacing: 0.05em; text-transform: uppercase;">
                        <span style="color: #10b981;">Long Shot</span><sup style="font-size: 10px;">‚Ñ¢</sup>
                    </p>
                    <p style="color: #64748b; font-size: 10px; margin: 10px 0; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase;">
                        AI-Powered ‚Ä¢ ML Predictions ‚Ä¢ Options Intelligence
                    </p>
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(148, 163, 184, 0.2);">
                        <p style="color: #94a3b8; font-size: 9px; margin: 8px 0; line-height: 1.6;">
                            This analysis is for informational purposes only and does not constitute financial advice.<br>
                            Past performance does not guarantee future results. Invest responsibly.
                        </p>
                        <p style="color: #64748b; font-size: 9px; margin: 10px 0; opacity: 0.7;">
                            ¬© 2026 Long Shot‚Ñ¢ ‚Ä¢ All Rights Reserved
                        </p>
                    </div>
                </div>
            </div>
            `;
        }
    </script>
</body>
</html>